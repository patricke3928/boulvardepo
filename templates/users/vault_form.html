{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>{% if action == "create" %}Add Password{% else %}Edit Password{% endif %} - TravelBook</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
html, body {
    margin: 0; padding: 0;
    width: 100%; height: 100%;
    font-family: 'Poppins', sans-serif;
    overflow: hidden;
    background: #0a0a0a;
    color: #fff;
}

canvas#bg {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    z-index: 0;
    pointer-events: none;
}

.vault-container {
    position: relative;
    z-index: 1;
    background: rgba(255,255,255,0.08);
    backdrop-filter: blur(15px);
    padding: 30px;
    border-radius: 25px;
    box-shadow: 0 15px 40px rgba(0,0,0,0.6);
    max-width: 600px;
    margin: 50px auto;
}

h2 { font-weight: 600; font-size: 24px; margin-bottom: 20px; }

.form-group { margin-bottom: 15px; }
.form-group label { display: block; margin-bottom: 5px; }
.form-group input {
    width: 100%; padding: 10px;
    border-radius: 10px; border: none;
    background: rgba(255,255,255,0.05); color: #fff;
}

.button {
    display: inline-block; padding: 10px 20px;
    font-weight: bold; font-size: 14px;
    text-align: center; color: #fff; text-decoration: none;
    border-radius: 12px;
    background: rgba(109,86,145,0.25);
    backdrop-filter: blur(10px);
    box-shadow: 0 6px 15px rgba(109,86,145,0.4);
    border: 1px solid rgba(255,255,255,0.1);
    transition: all 0.3s ease; cursor: pointer;
    margin: 5px;
    min-width: 120px;
}
.button:hover { background: rgba(155,127,200,0.3); transform: scale(1.03); }

.button-row {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 5px;
}
</style>
</head>
<body>

<canvas id="bg"></canvas>

<div class="vault-container">
    <h2>{% if action == "create" %}Add New Password{% else %}Edit Password{% endif %}</h2>

    <form method="post">
        {% csrf_token %}
        <div class="form-group">
            <label for="id_title">Title</label>
            {{ form.title }}
        </div>
        <div class="form-group">
            <label for="plain_password">Password</label>
            <input type="text" name="plain_password" id="plain_password" placeholder="Enter password">
            <div class="button-row">
                <button type="button" id="generate-rsa" class="button">Generate RSA Password</button>
                <button type="button" id="copy-password" class="button">Copy</button>
            </div>
        </div>

        <div class="button-row">
            <button type="submit" class="button">{% if action == "create" %}Save{% else %}Update{% endif %}</button>
            <a href="{% url 'users:vault_list' %}" class="button">Cancel</a>
        </div>
    </form>
</div>

<script>

const canvas = document.getElementById('bg');
const ctx = canvas.getContext('2d');
canvas.width = innerWidth; canvas.height = innerHeight;

const particles = [];
const PARTICLE_COUNT = 120;
const MAX_DISTANCE = 150;

class Particle {
    constructor(){ this.reset(); }
    reset(){ this.x=Math.random()*canvas.width; this.y=Math.random()*canvas.height; this.vx=(Math.random()-0.5)*1.2; this.vy=(Math.random()-0.5)*1.2; this.size=Math.random()*3+1; }
    update(){ this.x+=this.vx; this.y+=this.vy; if(this.x<0||this.x>canvas.width)this.vx*=-1; if(this.y<0||this.y>canvas.height)this.vy*=-1; }
    draw(){ ctx.beginPath(); ctx.arc(this.x,this.y,this.size,0,Math.PI*2); ctx.fillStyle='rgba(109,86,145,0.8)'; ctx.fill(); }
}
for(let i=0;i<PARTICLE_COUNT;i++) particles.push(new Particle());

function animate(){
    ctx.fillStyle='rgba(10,10,10,0.1)'; ctx.fillRect(0,0,canvas.width,canvas.height);
    for(let i=0;i<particles.length;i++){
        const p1=particles[i]; p1.update(); p1.draw();
        for(let j=i+1;j<particles.length;j++){
            const p2=particles[j]; const dx=p1.x-p2.x; const dy=p1.y-p2.y; const dist=Math.sqrt(dx*dx+dy*dy);
            if(dist<MAX_DISTANCE){
                ctx.beginPath();
                ctx.strokeStyle=`rgba(109,86,145,${1-dist/MAX_DISTANCE})`;
                ctx.lineWidth=1; ctx.moveTo(p1.x,p1.y); ctx.lineTo(p2.x,p2.y); ctx.stroke();
            }
        }
    }
    requestAnimationFrame(animate);
}
animate();
window.addEventListener('resize',()=>{canvas.width=innerWidth; canvas.height=innerHeight;});


document.getElementById('copy-password').addEventListener('click', () => {
    const input = document.getElementById('plain_password');
    input.select(); input.setSelectionRange(0, 99999);
    navigator.clipboard.writeText(input.value);
    alert('Password copied to clipboard!');
});


document.getElementById('generate-rsa').addEventListener('click', async () => {
    try {
        const response = await fetch("{% url 'users:generate_rsa_password' %}");
        if(!response.ok) throw new Error('Network error');
        const data = await response.json();
        document.getElementById('plain_password').value = data.password;
    } catch(err){
        alert('Failed to generate RSA password: ' + err.message);
    }
});
</script>

</body>
</html>
